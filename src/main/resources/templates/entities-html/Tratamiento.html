<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Gestión de Tratamientos')}"></head>
<body>

<div th:replace="~{fragments/nav :: nav}"></div>

<div class="container">

    <div class="card bg-light border-0 mb-4 shadow-sm" th:if="${cita != null}">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <h4 class="mb-1 text-primary fw-bold">
                        <i class="fas fa-file-medical-alt me-2"></i>Gestión de Tratamientos
                    </h4>
                    <p class="mb-0 text-muted">
                        Mascota: <strong th:text="${cita.nombreMascotaStr}"></strong> |
                        Fecha: <span th:text="${#temporals.format(cita.fechaHora, 'dd-MM-yyyy HH:mm')}"></span>
                    </p>
                </div>

                <div class="col-md-5 text-end">
                    <a th:href="@{/tratamientos/nuevo/{id}(id=${cita.id})}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i> Añadir Servicio
                    </a>

                    <a th:href="@{/citas/detalle/{id}(id=${cita.id})}" class="btn btn-success btn-sm ms-2 fw-bold">
                        <i class="fas fa-check-circle me-1"></i> Finalizar y Ver Detalle
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4" th:if="${cita == null}">
        <h2 class="text-secondary"><i class="fas fa-list"></i> Historial Global de Tratamientos</h2>
        <a href="/citas" class="btn btn-outline-primary">Ir a Citas</a>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <table class="table table-striped align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>Descripción</th>
                    <th>Info Adicional</th>
                    <th class="text-end">Precio (€)</th>
                    <th class="text-end pe-4">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="trat : ${tratamientos}">
                    <td>
                        <span class="fw-bold" th:text="${trat.descripcion}"></span>
                        <br>
                        <small class="text-muted" th:text="${trat.medicamento != null} ? ${trat.medicamento} : '-'"></small>
                    </td>
                    <td>
                        <span class="badge bg-secondary" th:text="${trat.cita.nombreMascotaStr}"></span>
                        <br>
                        <small th:text="${#temporals.format(trat.cita.fechaHora, 'dd-MM-yyyy')}"></small>
                    </td>
                    <td class="text-end fw-bold" th:text="${trat.precio} + ' €'">0.0 €</td>
                    <td class="text-end pe-3">
                        <a th:href="@{/tratamientos/editar/{id}(id=${trat.id})}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-pencil-alt"></i>
                        </a>
                        <a th:href="@{/tratamientos/eliminar/{id}(id=${trat.id})}"
                           class="btn btn-sm btn-outline-danger"
                           onclick="return confirm('¿Eliminar este tratamiento?');">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(tratamientos)}">
                    <td colspan="4" class="text-center py-4 text-muted">
                        No se han registrado tratamientos para esta cita.
                    </td>
                </tr>
                </tbody>

                <tfoot class="table-light" th:if="${cita != null}">
                <tr>
                    <td colspan="2" class="text-end fw-bold fs-5">Total Acumulado:</td>
                    <td class="text-end fw-bold fs-5 text-primary" th:text="${cita.getCosteTotal()} + ' €'">0.0 €</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>